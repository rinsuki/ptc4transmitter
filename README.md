# ptc4transmitter

(パソコン → )Raspberry Pi Zero W(H) → プチコン4 のデータ転送を実現するプログラム類です。

# 免責事項 disclaimer

これを使うのは自己責任でお願いします。これを使った結果何が起こっても(例: Switchがでかい文鎮になったりラズパイが燃えたりラズパイのSDカードがお釈迦になったり)責任を取りません。

# 使い方

:warning: この説明まだ序盤しか書いてないからラズパイを買いに走るのはまだ早いですよ!!

## 必要なもの

- **ある程度のLinuxに関する知識**
    - 重要
    - GNU nanoとかvi(m)とかemacsとかで設定ファイルの編集をできたり、一個のファイルでできたC言語のソースをコンパイルできたり、git cloneとかできれば大丈夫なはず
    - 作者に聞いてもろくにサポートする気はないので、自分に知識がないなら、自分の言うことを何でも聞いてくれそうでかつLinux知識がある程度ありそうな人を捕まえてからやるのがいいでしょう (存在するのかは置いといて)
- Nintendo Switch 本体
- プチコン4
- **2.4GHzの**無線LANでインターネットに接続できる環境
    - いわずもがな
    - 5GHzはラズパイが対応してない気がする
    - 公衆Wi-Fiとかだと繋がってる端末同士の通信ができなかったりいろいろ面倒なのでやめといたほうがいいです。最低でもスマホのテザリング
- Raspberry Pi Zero W (H)
    - HはGPIOのピンヘッダがあるかないかなので、どっちでもいいです
        - が、Hじゃない方は入手が面倒らしいので、面倒だったらHでいいと思います
    - 検証していませんが、理論上はUSBポートが1つしかないRaspberry Piなら何でもいけるはずです。が、そうなると外からの通信がGPIOポートになったりType-Aのオスオスケーブルが必要になったりめちゃくちゃ面倒くさいので非推奨です。
- いい感じのUSBの電源
    - Switchのドックから取る分だと足りないっぽいので。
    - 最悪PCのバスパワーとかで構いません。本当はACアダプターから取ったほうがいい気がするけど。
- Type-Aのオス ⇔ microBのオス ケーブル * 2
    - 電源用と通信用
- 何らかのNintendo SwitchにType-Aを繋ぐやつ
    - Nintendo Switchのドックとかでいい
    - 携帯/テーブルモードでやるつもりなら適当なやつが必要になる (USB Type-C OTG とかそういうやつ)
        - 適当にそのへんに売ってるのを買ってくれば使えるのでは
- Raspberry Pi Zero W (H)で使えるmicroSDカード
    - 4GBとか8GBとかあればいい気がする
    - 一部のカードは相性問題があるので注意。インターネットで検索するといい感じの情報が出てきたり出てこなかったりします
    - 心配ならRaspberry Pi Zero W スターターキットみたいなのを買うとよさそう
- 作業用のパソコン
    - SDカードにイメージを焼く必要があるのでパソコンは必須。
    - SSHができるとよい (最近のWindows 10ならOpenSSHがあるとかないとか)
    - mDNS(Bonjour)で名前解決ができるとなおよい 
        - 最新じゃないWindowsだとiTunesを入れる必要があるかも
        - Macなら大丈夫
        - Linuxは avahi-daemon とかをインストールして有効化する必要がありそう
- (パソコンでmicroSDが読み書きできないなら) SDカードリーダライター
    - お手持ちのパソコンで使えるやつを選んでください。

## 別に必須ではないけどあるといいかもしれないもの

- miniHDMI から HDMI にしてくれるやつ
    - ラズパイの画面が見たいならいる。別に必須ではない
    - 起動ログが生で見れると便利かも (SDカードが死んだときとか)
- Raspberry Pi Zero WH用カメラ
    - 将来的な双方向通信に使うかもしれないが、そこまでやろうとするとラズパイ一台じゃ処理が追い付かない気がするので、**今この時点でこのためだけに買うのはおすすめできない**


# 手順

## 0. Raspberry PiにWi-Fi経由でSSHできるようにする

いい感じにインターネットからセットアップ手順をひっぱってくるとよいでしょう。
おすすめはラズパイをUSBイーサネットアダプタに偽造してmDNSで探してSSHで繋ぐ方法です。

https://www.raspi.jp/2016/07/pizero-usb-otg/ とかを見るといいんじゃないでしょうか。

あと、`pi`ユーザー、`root`ユーザーのパスワードは一応変えておいたほうがいいと思います。sshdのポートも変えたほうがいいかも。

再起動後でも無線LANに自動で接続してWi-Fi経由でSSHができるようになったら進みましょう。

## 1. Raspberry PiをUSBゲストにする

この手順を行うと(設定の再変更なしには)USB OTGでパソコンと繋げなくなります。
再起動後にWi-Fiに自動接続できることを確認してから進んでください。

OTG 経由でセットアップした場合は、`config.txt`に`dtoverlay=dwc2`、`cmdline.txt`に`modules-load=dwc2,g_ether`を追記したと思いますが、`cmdline.txt`に追記したほうを消してください。
パソコンにSDカードを繋いだときにルート階層に見えていたファイルは、Raspberry Pi内では`/boot/`に見えています。
編集する前に`cmdline.txt`のバックアップを取っておくといいでしょう。

OTG経由じゃない方法でセットアップした場合は、`config.txt`に`dtoverlay=dwc2`を追記してください (最初に改行が必要です)。

また、OTG経由でもそうじゃなくても、`/etc/modules` に `libcomposite`を追記してください。

設定したら`sudo reboot`して、再起動後しばらくすればsshに繋げることを確認してください。

## 2. ソースコードの取得

このソースコードを得るためには`git`が必要です。
```
sudo apt install git
```
でインストールできます。

インストールしたら、ホームディレクトリとか適当なところで

```
git clone https://github.com/rinsuki/ptc4transmitter
```
します。

```
Cloning into 'ptc4transmitter'...
remote: Enumerating objects: 3, done.
remote: Counting objects: 100% (3/3), done.
remote: Compressing objects: 100% (2/2), done.
remote: Total 3 (delta 0), reused 3 (delta 0), pack-reused 0
Unpacking objects: 100% (3/3), done.
```

みたいなログが流れたら成功です。
カレントディレクトリに`ptc4transmitter`というフォルダができているのを確認してください。

## 3. カーネルモジュールのビルド

あとで書く

## 4. 送信プログラムのビルド

あとで書く

## 5. プチコン4でのプログラムのダウンロード

あとで書く

## 6. 転送

あとで書く